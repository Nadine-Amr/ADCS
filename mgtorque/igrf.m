% New IGRF

 function [Bx,By,Bz]= igrf(x,y,z)
r=sqrt(x^2+y^2+z^2);
Re=6378136.3;
g=[0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
    -29497,-1585.90000000000,0,0,0,0,0,0,0,0,0,0,0,0;...
    -2396.60000000000,3026,1668.60000000000,0,0,0,0,0,0,0,0,0,0,0;...
    1339.70000000000,-2326.30000000000,1231.70000000000,634.200000000000,0,0,0,0,0,0,0,0,0,0;...
    912.600000000000,809,166.600000000000,-357.100000000000,89.7000000000000,0,0,0,0,0,0,0,0,0;...
    -231.100000000000,357.200000000000,200.300000000000,-141.200000000000,-163.100000000000,-7.70000000000000,0,0,0,0,0,0,0,0;...
    72.8000000000000,68.6000000000000,76,-141.400000000000,-22.9000000000000,13.1000000000000,-77.9000000000000,0,0,0,0,0,0,0;...
    80.4000000000000,-75,-4.70000000000000,45.3000000000000,14,10.4000000000000,1.60000000000000,4.90000000000000,0,0,0,0,0,0;...
    24.3000000000000,8.20000000000000,-14.5000000000000,-5.70000000000000,-19.3000000000000,11.6000000000000,10.9000000000000,-14.1000000000000,-3.70000000000000,0,0,0,0,0;...
    5.40000000000000,9.40000000000000,3.40000000000000,-5.30000000000000,3.10000000000000,-12.4000000000000,-0.800000000000000,8.40000000000000,-8.40000000000000,-10.1000000000000,0,0,0,0;...
    -2,-6.30000000000000,0.900000000000000,-1.10000000000000,-0.200000000000000,2.50000000000000,-0.300000000000000,2.20000000000000,3.10000000000000,-1,-2.80000000000000,0,0,0;...
    3,-2.5,-2.10000000000000,1.60000000000000,-0.500000000000000,0.500000000000000,-0.800000000000000,0.400000000000000,1.80000000000000,0.200000000000000,0.800000000000000,3.80000000000000,0,0;...
    -2.10000000000000,-0.200000000000000,0.300000000000000,1,-0.700000000000000,0.900000000000000,-0.100000000000000,0.500000000000000,-0.400000000000000,-0.400000000000000,0.200000000000000,-0.800000000000000,0,0;...
    -0.200000000000000,-0.900000000000000,0.300000000000000,0.400000000000000,-0.400000000000000,1.10000000000000,-0.300000000000000,0.800000000000000,-0.200000000000000,0.400000000000000,0,0.400000000000000,-0.300000000000000,-0.300000000000000];

h=[0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
    0,4945.10000000000,0,0,0,0,0,0,0,0,0,0,0,0;...
    0,-2707.70000000000,-575.400000000000,0,0,0,0,0,0,0,0,0,0,0;...
    0,-160.500000000000,251.700000000000,-536.800000000000,0,0,0,0,0,0,0,0,0,0;...
    0,286.400000000000,-211.200000000000,164.400000000000,-309.200000000000,0,0,0,0,0,0,0,0,0;...
    0,44.7000000000000,188.900000000000,-118.100000000000,0.100000000000000,100.900000000000,0,0,0,0,0,0,0,0;...
    0,-20.8000000000000,44.2000000000000,61.5000000000000,-66.3000000000000,3.10000000000000,54.9000000000000,0,0,0,0,0,0,0;...
    0,-57.8000000000000,-21.2000000000000,6.60000000000000,24.9000000000000,7,-27.7000000000000,-3.40000000000000,0,0,0,0,0,0;...
    0,10.9000000000000,-20,11.9000000000000,-17.4000000000000,16.7000000000000,7.10000000000000,-10.8000000000000,1.70000000000000,0,0,0,0,0;...
    0,-20.5000000000000,11.6000000000000,12.8000000000000,-7.20000000000000,-7.40000000000000,8,2.20000000000000,-6.10000000000000,7,0,0,0,0;...
    0,2.80000000000000,-0.100000000000000,4.70000000000000,4.40000000000000,-7.20000000000000,-1,-4,-2,-2,-8.30000000000000,0,0,0;...
    0,0.100000000000000,1.70000000000000,-0.600000000000000,-1.80000000000000,0.900000000000000,-0.400000000000000,-2.50000000000000,-1.30000000000000,-2.10000000000000,-1.90000000000000,-1.80000000000000,0,0;...
    0,-0.800000000000000,0.300000000000000,2.20000000000000,-2.50000000000000,0.500000000000000,0.600000000000000,0,0.100000000000000,0.300000000000000,-0.900000000000000,-0.200000000000000,0.800000000000000,0;...
    0,-0.800000000000000,0.300000000000000,1.70000000000000,-0.600000000000000,-1.20000000000000,-0.100000000000000,0.500000000000000,0.100000000000000,0.500000000000000,0.400000000000000,-0.200000000000000,-0.500000000000000,-0.800000000000000];

Bx=0;
By=0;
Bz=0;
ddp=1;
v=zeros(15,15);
for n=0:14;
    for m=0:n;
       nn=n+1;
       mm=m+1;
        if n==0;
            v(1,1)=1/r;
        elseif n==m;
            v(nn,nn)=(2*n-1)*((x+y*1i)/r^2)*v(nn-1,nn-1);
        elseif n-m==1;
            v(nn,mm)=((2*n-1)/(n-m))*(z/r^2)*v(nn-1,mm);
        else
             v(nn,mm)=((2*n-1)/(n-m))*(z/r^2)*v(nn-1,mm)-((n+m-1)/(n-m))*(1/r^2)*v(nn-2,mm);
        end     
    end 
end  
for n=0:13;
    for m=0:n;
        mm=m+1;
        nn=n+1;        
         if n==1;
            dd=1;
        elseif m==0;
            dd=1;
        elseif n==m;
            ddp=ddp*(1/(sqrt((2*n-1)*2*n)));
            dd=ddp;
        else
            dd=sqrt(2)*sqrt(factorial(n-m)/factorial(n+m));
         end
         if m==0;
            dxv=-0.5*(v(nn+1,2)+conj(v(nn+1,2))); 
            dyv=0.5*1i*(v(nn+1,2)-conj(v(nn+1,2))); 
        else
            dxv=-0.5*(v(nn+1,mm+1)-(factorial(n-m+2)/factorial(n-m))*v(nn+1,mm-1));
            dyv=0.5*1i*(v(nn+1,mm+1)+(factorial(n-m+2)/factorial(n-m))*v(nn+1,mm-1));
         end
         dzv=((-factorial(n-m+1)/factorial(n-m))*v(nn+1,mm));
         
        bx=Re^n*(g(n+1,m+1)-1i*h(n+1,m+1))*dd*dxv;
        Bx=Bx+bx;
        by=Re^n*(g(n+1,m+1)-1i*h(n+1,m+1))*dd*dyv;
        By=By+by;
        bz=Re^n*(g(n+1,m+1)-1i*h(n+1,m+1))*dd*dzv;
        Bz=Bz+bz;
    end
end
Bx=-Re^2*real(Bx)
By=-Re^2*real(By)
Bz=-Re^2*real(Bz)
end